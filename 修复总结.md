# macOS 构建问题修复总结

## 已修复的问题

### 1. zlib fdopen 宏冲突 ✅

**问题**: binutils 和 GCC 的 zlib 库中定义的 `fdopen` 宏与 macOS SDK 系统头文件冲突。

**修复**:
- 在 `binutils-2.44/zlib/zutil.h` 和 `gcc-13.2.0/zlib/zutil.h` 中，将：
  ```c
  #        define fdopen(fd,mode) NULL /* No fdopen() */
  ```
  改为：
  ```c
  #        ifdef __APPLE__
  #          undef fdopen
  #        else
  #          define fdopen(fd,mode) NULL /* No fdopen() */
  #        endif
  ```

### 2. setlocale 宏冲突 ✅

**问题**: GCC libcpp 的 `setlocale` 宏与 macOS 的 `libintl.h` 冲突。

**修复**:
- 在 `gcc-13.2.0/libcpp/system.h` 中，在包含 `libintl.h` 之前添加：
  ```c
  #ifdef __APPLE__
  # undef setlocale
  #endif
  ```

### 3. ctype 宏冲突 ✅

**问题**: GCC 的 `safe-ctype.h` 定义的 ctype 宏（如 `isupper`, `islower` 等）与 macOS C++ 标准库的 locale 函数冲突。

**修复**:
- 在 `gcc-13.2.0/gcc/system.h` 中，在包含 C++ 标准库头文件之前临时取消这些宏定义
- 在包含 C++ 头文件之后恢复宏定义

### 4. 自动配置 ✅

**修复**:
- 自动添加 `BINUTILS_CONFIG += --without-zlib` 配置
- 自动检测 macOS 并使用 `shasum` 替代 `sha1sum`
- 自动使用 `curl` 如果 `wget` 不可用

## 使用方法

构建脚本 `build-all.sh` 会自动检测 macOS 并应用所有修复：

```bash
./build-all.sh
```

脚本会自动：
1. 检测 macOS 环境
2. 修复 binutils 和 GCC 的 zlib 文件
3. 修复 GCC libcpp 的 setlocale 问题
4. 应用所有必要的配置

## 验证

构建成功后，使用测试脚本验证：

```bash
./test-toolchain.sh
```

